"<html>\n"
"\n"
"<!--Player Index <input type=\"number\" id=\"player_index\" value=\"0\" step=\"1\" min=\"0\" max=\"3\" /> -->\n"
"\n"
"<!--\n"
"	Key bindings\n"
"    {\"key_right\",&key_right, 'D'},\n"
"    {\"key_left\",&key_left, 'A'},\n"
"    {\"key_up\",&key_up, 'W'},\n"
"    {\"key_down\",&key_down, 'S'},\n"
"    {\"key_strafeleft\",&key_strafeleft, 'Q'},\n"
"    {\"key_straferight\",&key_straferight, 'E'},\n"
"\n"
"    {\"key_fire\",&key_fire, 'F'},\n"
"    {\"key_use\",&key_use, 'U'},\n"
"    {\"key_strafe\",&key_strafe, KEY_RALT},\n"
"    {\"key_speed\",&key_speed, KEY_RSHIFT},\n"
"-->\n"
"\n"
"<div id=\"overlay\" onclick=\"removeControlsOverlay()\">\n"
"	<div id=\"text\">\n"
"		W to move forward\n"
"		S to move backward\n"
"		A to turn left\n"
"		D to turn right\n"
"		Q to strafe left\n"
"		E to strafe right\n"
"		F to fire\n"
"		U to use (and respawn)\n"
"	</div>\n"
"  </div>\n"
"\n"
"<canvas id=\"framebuffer\"></canvas>\n"
"\n"
"<div id=\"controlsbutton\">\n"
"<button onClick=\"showControlsOverlay();\">Show Controls</button>\n"
"</div>\n"
"<div id=\"version\">\n"
"</div>\n"
"\n"
"<div id=\"waiting\">\n"
"Too Many Players; please wait.\n"
"</div>\n"
"\n"
"<style>\n"
"body {\n"
"	margin: 0;\n"
"	background: black;\n"
"}\n"
"\n"
"#waiting {\n"
"	color: white;\n"
"}\n"
"\n"
"#version {\n"
"	color: white;\n"
"}\n"
"\n"
"div {\n"
"    white-space: pre-wrap;\n"
"}\n"
"\n"
"canvas { \n"
"	width: 100%; \n"
"	max-width: 960px; \n"
"	margin: 0 auto; \n"
"}\n"
"\n"
"table {\n"
"  table-layout: fixed;\n"
"  width: 40%;\n"
"  border-collapse: collapse;\n"
"  border: 2px solid purple;\n"
"}\n"
"\n"
"thead th:nth-child(1) {\n"
"  width: 10%;\n"
"}\n"
"\n"
"thead th:nth-child(2) {\n"
"  width: 70%;\n"
"}\n"
"\n"
"thead th:nth-child(3) {\n"
"  width: 20%;\n"
"}\n"
"\n"
"th, td {\n"
"  padding: 5px;\n"
"}\n"
"\n"
"tbody td {\n"
"  text-align: center;\n"
"}\n"
"\n"
"thead td {\n"
"	text-align: center;\n"
"}\n"
"\n"
"table td, table th {\n"
"	white-space: pre-wrap;\n"
"	border: 1px solid black;\n"
"}\n"
"\n"
"#overlay {\n"
"  position: fixed;\n"
"  display: none;\n"
"  width: 100%;\n"
"  height: 100%;\n"
"  top: 0;\n"
"  left: 0;\n"
"  right: 0;\n"
"  bottom: 0;\n"
"  background-color: rgba(0,0,0,0.5);\n"
"  z-index: 2;\n"
"  cursor: pointer;\n"
"}\n"
"\n"
"#text{\n"
"  position: absolute;\n"
"  top: 50%;\n"
"  left: 50%;\n"
"  font-size: 20px;\n"
"  color: white;\n"
"  transform: translate(-50%,-50%);\n"
"  -ms-transform: translate(-50%,-50%);\n"
"}\n"
"\n"
"selector { cursor: none; }\n"
"</style>\n"
"\n"
"<script>\n"
"\n"
"const canvas = document.querySelector(\"canvas\");\n"
"\n"
"var Game = {\n"
"	stopMain: {},\n"
"	started: false,\n"
"	sessionId: -1,\n"
"	playerId: -1,\n"
"	playerIndex: 0,\n"
"	globalpop: false,\n"
"	pop: \"\",\n"
"	host: \"\",\n"
"	version: 0,\n"
"	startpost: true,\n"
"	keys: {},\n"
"	frames: {},\n"
"	numframes: 0,\n"
"	lastTick: 0,\n"
"	lastRender: 0,\n"
"	countdown: 0,\n"
"\n"
"	maxposttimes: 100,\n"
"	posttimes: [100],\n"
"	numposttimes: 0,\n"
"	postindex: 0,\n"
"	postfull: false,\n"
"};\n"
"\n"
"function removeControlsOverlay() {\n"
"	document.getElementById(\"overlay\").style.display = \"none\";\n"
"};\n"
"\n"
"function showControlsOverlay() {\n"
"	document.getElementById(\"overlay\").style.display = \"block\";\n"
"}\n"
"\n"
"function AddPostTime(time) {\n"
"	if (!Game.postfull) {\n"
"		Game.numposttimes++;\n"
"	}\n"
"	if (Game.numposttimes == Game.maxposttimes) {\n"
"		Game.postfull = true;\n"
"	}\n"
"	Game.postindex = (Game.postindex + 1) % Game.numposttimes;\n"
"	Game.posttimes[Game.postindex] = time;\n"
"}\n"
"\n"
"function GetAveragePostTime() {\n"
"	var total = 0;\n"
"	for (i=0;i<Game.numposttimes;++i) {\n"
"		total += Game.posttimes[i];\n"
"	}\n"
"	return total / Game.numposttimes;\n"
"}\n"
"\n"
"function GeneratePostBody() {\n"
"	var numevents = Object.keys(Game.keys).length;\n"
"	var body = new ArrayBuffer(13 + numevents + 4);\n"
"	var view = new DataView(body);\n"
"	view.setUint32(0,Game.sessionId);\n"
"	view.setUint8(4,Game.globalpop);\n"
"\n"
"	view.setUint32(5, Game.playerIndex);\n"
"	view.setUint32(9, numevents);\n"
"	var index=0;\n"
"	for (var key in Game.keys) {\n"
"		view.setUint8(13+index,key);\n"
"		index++;\n"
"	}\n"
"	var num_requested_frames = 1; // adaptive frame interpolation isn't helping a lot yet.\n"
"	view.setUint32(13+index,num_requested_frames);\n"
"\n"
"	return body;\n"
"}\n"
"\n"
"// helper in case we need to download data for inspection\n"
"function download(filename, data) {\n"
"    var element = document.createElement('a');\n"
"    element.setAttribute('href', 'data:binary/octet-stream,' + data);\n"
"    element.setAttribute('download', filename);\n"
"\n"
"    element.style.display = 'none';\n"
"    document.body.appendChild(element);\n"
"\n"
"    element.click();\n"
"\n"
"    document.body.removeChild(element);\n"
"}\n"
"\n"
"document.addEventListener('contextmenu', event => event.preventDefault());\n"
"\n"
"document.addEventListener('keydown', (event) => {\n"
"  Game.keys[event.keyCode] = 1;\n"
"}, false);\n"
"\n"
"document.addEventListener('keyup', (event) => {\n"
"	delete Game.keys[event.keyCode];\n"
"}, false);\n"
"\n"
"document.addEventListener(\"mousedown\", (event) => {\n"
"	if (event.button == 0)\n"
"		Game.keys['F'.charCodeAt(0)] = 1;\n"
"	if (event.button == 2)\n"
"		Game.keys['U'.charCodeAt(0)] = 1;\n"
"}, false);\n"
"\n"
"document.addEventListener(\"mouseup\", (event) => {\n"
"	console.log(\"mouseup with \", event.button);\n"
"	if (event.button == 0)\n"
"		delete Game.keys['F'.charCodeAt(0)];\n"
"	if (event.button == 2)\n"
"		delete Game.keys['U'.charCodeAt(0)];\n"
"}, false);\n"
"\n"
"canvas.addEventListener(\"click\", async () => {\n"
"  if (!document.pointerLockElement) {\n"
"    await canvas.requestPointerLock({\n"
"      unadjustedMovement: true,\n"
"    });\n"
"  }\n"
"});\n"
"\n"
"document.addEventListener(\"pointerlockchange\", lockChangeAlert, false);\n"
"\n"
"function lockChangeAlert() {\n"
"  if (document.pointerLockElement === canvas) {\n"
"    console.log(\"The pointer lock status is now locked\");\n"
"    document.addEventListener(\"mousemove\", updatePosition, false);\n"
"  } else {\n"
"    console.log(\"The pointer lock status is now unlocked\");\n"
"    document.removeEventListener(\"mousemove\", updatePosition, false);\n"
"  }\n"
"}\n"
"\n"
"function updatePosition(e) {\n"
"	if (e.movementX > 5) {\n"
"		Game.keys['d'.charCodeAt(0)] = 1;\n"
"	}\n"
"	else if (e.movementX < -5) {\n"
"		Game.keys['a'.charCodeAt(0)] = 1;\n"
"	} else {\n"
"		delete Game.keys['d'.charCodeAt(0)];\n"
"		delete Game.keys['a'.charCodeAt(0)];\n"
"	}\n"
"}\n"
"\n"
"function RenderFrame() {\n"
"	const rawcanvas = document.getElementById('framebuffer');\n"
"	rawcanvas.width = 960;\n"
"	rawcanvas.height = 600;\n"
"	const ctx = rawcanvas.getContext('2d');\n"
"\n"
"	var imageData = ctx.getImageData(0, 0, 100, 100);\n"
"	var data = new Uint8ClampedArray(4 * 320 * 200);\n"
"\n"
"	var palette = new Uint8ClampedArray(256*3);\n"
"	for (var i = 0; i < 256 * 3; ++i) {\n"
"		palette[i] = Game.frames[0][i];\n"
"	}\n"
"	//for (var i = 256*3; i < fb.length; i += 4) {\n"
"	fb_index = 256*3;\n"
"	for (var i = 0; i < data.length; i += 4) {\n"
"		data[i] = palette[Game.frames[0][fb_index]*3];\n"
"		data[i+1] = palette[Game.frames[0][fb_index]*3+1];\n"
"		data[i+2] = palette[Game.frames[0][fb_index]*3+2];\n"
"		data[i+3] = 255;\n"
"		fb_index++;\n"
"	}\n"
"\n"
"	var imageData = new ImageData(data, 320,200);\n"
"	tempcanvas = document.createElement('canvas');\n"
"	tempcanvas.width=320;\n"
"	tempcanvas.height=200;\n"
"	var tempctx = tempcanvas.getContext('2d');\n"
"	tempctx.putImageData(imageData,0,0);\n"
"\n"
"	ctx.scale(3,3);\n"
"	ctx.drawImage(tempcanvas,0,0);\n"
"	Game.lastRender = performance.now();\n"
"}\n"
"\n"
"function GetFrame() {\n"
"	var xhttp = new XMLHttpRequest();\n"
"	var startpost = performance.now();\n"
"	xhttp.onload = function(oEvent) {\n"
"		var posttime = performance.now() - startpost;\n"
"		AddPostTime(posttime);\n"
"		var arraybuffer = xhttp.response;\n"
"		if (arraybuffer) {\n"
"			var byteArray = new Uint8Array(arraybuffer);\n"
"			var dv = new DataView(arraybuffer);\n"
"\n"
"			let num_frames = dv.getInt32(0, true); // number of frames\n"
"			let frame_len = 320*200 + 768;\n"
"\n"
"			for (i=0;i<num_frames;++i) {\n"
"				let fb = new Uint8Array(arraybuffer.slice(4+i*frame_len));\n"
"				Game.frames[i] = fb;\n"
"			}\n"
"\n"
"			Game.numframes = num_frames;\n"
"\n"
"			Game.sessionId = dv.getInt32(4+num_frames*frame_len,true);\n"
"\n"
"			var poplen = dv.getInt32(8+num_frames*frame_len,true);\n"
"			var poparray = new Uint8Array(arraybuffer.slice(12+num_frames*frame_len,12+num_frames*frame_len+poplen));\n"
"			var pop = new TextDecoder(\"utf-8\").decode(poparray);\n"
"			if (Game.pop != pop) {\n"
"				Game.pop = pop;\n"
"				var pop_update = new XMLHttpRequest();\n"
"				pop_update.open(\"POST\", \"https://loudly-verified-elephant.edgecompute.app/update_pop_in_session\", true);\n"
"				pop_update.setRequestHeader(\"playerid\",Game.playerId);\n"
"				pop_update.setRequestHeader(\"sessionid\",Game.sessionId);\n"
"				pop_update.setRequestHeader(\"pop\",Game.pop);\n"
"				pop_update.send();\n"
"			}\n"
"\n"
"			var hostlen = dv.getInt32(12+num_frames*frame_len + poplen,true);\n"
"			var hostarray = new Uint8Array(arraybuffer.slice(16+num_frames*frame_len + poplen,16+num_frames*frame_len + poplen + hostlen));\n"
"			Game.host = new TextDecoder(\"utf-8\").decode(hostarray);\n"
"\n"
"			var version = dv.getInt32(16+num_frames*frame_len + poplen + hostlen,true);\n"
"			Game.version = version;\n"
"			document.getElementById('version').innerHTML = version;\n"
"\n"
"\n"
"			Game.startpost = true;\n"
"		}\n"
"	};\n"
"	xhttp.open(\"POST\", \"https://especially-cunning-bat.edgecompute.app/doomframe\", true);\n"
"	xhttp.responseType = \"arraybuffer\";\n"
"	var body = GeneratePostBody();\n"
"    xhttp.send(body);\n"
"}\n"
"\n"
";(function () {\n"
"	function main( tFrame ) {\n"
"		Game.stopMain = window.requestAnimationFrame( main );\n"
"		var delta = tFrame-Game.lastTick;\n"
"		Game.lastTick = tFrame;\n"
"\n"
"		if (Game.started) {\n"
"			if (Game.numframes > 0)\n"
"				RenderFrame();\n"
"\n"
"			if (Game.startpost)\n"
"			{\n"
"				GetFrame();\n"
"				Game.startpost = false;\n"
"			}\n"
"		}\n"
"	}\n"
"\n"
"	function get_value_from_cookie(key) {\n"
"		var value;\n"
"		var row = document.cookie\n"
"			.split('; ')\n"
"			.find(row => row.startsWith(key));\n"
"			if (typeof row != \"undefined\") {\n"
"				value = row.split('=')[1];\n"
"			} else {\n"
"				value = \"\";\n"
"			}\n"
"		return value;\n"
"	}\n"
"\n"
"	function lobby_heartbeat() {\n"
"		var heartbeat_req = new XMLHttpRequest();\n"
"		heartbeat_req.onload = function(oEvent) {\n"
"			Game.countdown = 30;\n"
"			if (!Game.started && heartbeat_req.status == 200) {\n"
"				create_and_join_session();\n"
"			}\n"
"		}\n"
"\n"
"		heartbeat_req.open(\"POST\", \"https://loudly-verified-elephant.edgecompute.app/heartbeat\", true);\n"
"		heartbeat_req.responseType = \"text\";\n"
"		heartbeat_req.setRequestHeader(\"sessionid\",Game.sessionId);\n"
"		heartbeat_req.setRequestHeader(\"playerid\",Game.playerId);\n"
"		heartbeat_req.send();\n"
"	}\n"
"\n"
"	function lobby_counter() {\n"
"		Game.countdown -= 1;\n"
"		var el = document.getElementById('waiting');\n"
"		waiting.innerText = \"Too many players; retrying in \" + Game.countdown + \" seconds.\";\n"
"	}\n"
"\n"
"	function init_user() {\n"
"		var playerid=get_value_from_cookie('playerid');\n"
"		var playername = get_value_from_cookie('playername');\n"
"\n"
"		if (playerid == 0) {\n"
"			playerid = Math.floor(Math.random() * 100000);\n"
"			document.cookie = \"playerid=\"+playerid;\n"
"			playername=\"Player\" + playerid;\n"
"			document.cookie = \"playername=\"+playername;\n"
"		}\n"
"		Game.playerId = playerid;\n"
"		if (playername == \"\") {\n"
"			playername=\"Player\" + playerid;\n"
"			document.cookie = \"playername=\"+playername;\n"
"		}\n"
"		setInterval(lobby_heartbeat, 1000 * 30); // 30s interval\n"
"		Game.countdown = 30;\n"
"		setInterval(lobby_counter, 1000); // 1s interval\n"
"	}\n"
"\n"
"	function create_and_join_session() {\n"
"		var xhttp = new XMLHttpRequest();\n"
"		xhttp.onload = function(oEvent) {\n"
"			if (xhttp.status == 200) {\n"
"				var parts = xhttp.response.split(',');\n"
"				Game.sessionId = parts[0];\n"
"				Game.playerIndex = parts[1];\n"
"				Game.pop = parts[2];\n"
"				Game.lastTick = performance.now();\n"
"				Game.started = true;\n"
"				document.getElementById('controlsbutton').style.display = 'block';\n"
"				document.getElementById('waiting').style.display = 'none';\n"
"				main(performance.now());\n"
"			} else {\n"
"				Game.started = false;\n"
"				document.getElementById('controlsbutton').style.display = 'none';\n"
"				document.getElementById('waiting').style.display = 'block';\n"
"				main(performance.now());\n"
"			}\n"
"		};\n"
"		xhttp.open(\"POST\", \"https://loudly-verified-elephant.edgecompute.app/create_and_join_session\", true);\n"
"		xhttp.responseType = \"text\";\n"
"		xhttp.setRequestHeader(\"id\",Game.playerId);\n"
"		var playername = get_value_from_cookie('playername');\n"
"		xhttp.setRequestHeader(\"name\", playername);\n"
"		xhttp.send();\n"
"	}\n"
"\n"
"	init_user();\n"
"	create_and_join_session();\n"
"})();\n"
"</script>\n"
"</html\n"
